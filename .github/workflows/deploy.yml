name: 🚀 CI/CD a Railway (Spring Boot + Docker)

on:
  push:
    branches:
      - main
      - develop

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Clonamos el código
      - name: 🧹 Clonar el repositorio
        uses: actions/checkout@v4

      # 2️⃣ Instalamos Railway CLI
      - name: ⚙️ Instalar Railway CLI
        run: npm install -g @railway/cli

      # 3️⃣ Construir la imagen Docker de Spring Boot
      - name: 🏗️ Construir imagen Docker
        run: |
          docker build -t viajafacil-backend -f Dockerfile .

      # 4️⃣ Verificar si se construyó correctamente
      - name: ✅ Verificar imagen
        run: docker images

      # 5️⃣ Desplegar a PRODUCCIÓN (main)
      - name: 🟢 Desplegar a PRODUCCIÓN
        if: github.ref_name == 'main'
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_PROJECT_TOKEN }}
        run: |
          echo "🚀 Desplegando main-area a viajafacil-devops-production.up.railway.app"
          railway up --service=${{ secrets.RAILWAY_SERVICE_ID_MAIN }}

      # 6️⃣ Desplegar a STAGING (develop)
      - name: 🧪 Desplegar a STAGING
        if: github.ref_name == 'develop'
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_PROJECT_TOKEN }}
        run: |
          echo "🚀 Desplegando develop-area a develop-area-production.up.railway.app"
          railway up --service=${{ secrets.RAILWAY_SERVICE_ID_DEVELOP }} -- --force