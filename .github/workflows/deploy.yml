name: ğŸš€ CI/CD a Railway (Spring Boot + Docker)

on:
  push:
    branches:
      - main
      - develop

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Clonamos el cÃ³digo
      - name: ğŸ§¹ Clonar el repositorio
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Instalamos Railway CLI
      - name: âš™ï¸ Instalar Railway CLI
        run: npm install -g @railway/cli

      # 3ï¸âƒ£ Autenticamos con el token
      - name: ğŸ”‘ Autenticarse en Railway
        env:
          RAILWAY_PROJECT_TOKEN: ${{ secrets.RAILWAY_PROJECT_TOKEN }}
        run: |
          echo "ğŸ” Usando token de Railway..."
          export RAILWAY_PROJECT_TOKEN= ${{ secrets.RAILWAY_PROJECT_TOKEN }}
          railway whoami || echo "AutenticaciÃ³n por token lista âœ…"

      # 4ï¸âƒ£ Construir la imagen Docker de Spring Boot
      - name: ğŸ—ï¸ Construir imagen Docker
        run: |
          docker build -t viajafacil-backend -f Dockerfile .

      # 5ï¸âƒ£ Verificar si se construyÃ³ correctamente
      - name: âœ… Verificar imagen
        run: docker images

      # 6ï¸âƒ£ Desplegar a Railway segÃºn la rama
      - name: ğŸš€ Desplegar a Railway
        env:
          RAILWAY_PROJECT_TOKEN: ${{ secrets.RAILWAY_PROJECT_TOKEN }}
        run: |
          echo "ğŸ” Detectando rama: $GITHUB_REF_NAME"
          if [ "${GITHUB_REF_NAME}" == "main" ]; then
            echo "ğŸŸ¢ Desplegando a PRODUCCIÃ“N..."
            railway up --service viajafacil-devops-production
          else
            echo "ğŸ§ª Desplegando a STAGING..."
            railway up --service develop-area-production
          fi
