name: ğŸš€ CI/CD a Railway (Spring Boot + Docker)

on:
  push:
    branches:
      - main
      - develop

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Clonamos el cÃ³digo
      - name: ğŸ§¹ Clonar el repositorio
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Instalamos Railway CLI
      - name: âš™ï¸ Instalar Railway CLI
        run: npm install -g @railway/cli

      # 3ï¸âƒ£ Construir la imagen Docker de Spring Boot
      - name: ğŸ—ï¸ Construir imagen Docker
        run: |
          docker build -t viajafacil-backend -f Dockerfile .

      # 4ï¸âƒ£ Verificar si se construyÃ³ correctamente
      - name: âœ… Verificar imagen
        run: docker images

      # 5ï¸âƒ£ Desplegar a PRODUCCIÃ“N (main)
      - name: ğŸŸ¢ Desplegar a PRODUCCIÃ“N
        if: github.ref_name == 'main'
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_PROJECT_TOKEN }}
        run: |
          echo "ğŸš€ Desplegando main-area a viajafacil-devops-production.up.railway.app"
          railway up --service=${{ secrets.RAILWAY_SERVICE_ID_MAIN }}

      # 6ï¸âƒ£ Desplegar a STAGING (develop)
      - name: ğŸ§ª Desplegar a STAGING
        if: github.ref_name == 'develop'
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_PROJECT_TOKEN }}
        run: |
          echo "ğŸš€ Desplegando develop-area a develop-area-production.up.railway.app"
          railway up --service=${{ secrets.RAILWAY_SERVICE_ID_DEVELOP }} -- --force